{"version":3,"file":"index.js","sources":["../src/components/Loader/Loader.tsx","../src/helpers.ts","../src/index.tsx"],"sourcesContent":["import * as React from 'react';\nimport './Loader.styles.scss';\n\nconst Loader = () => (\n  <div className=\"csv-generator-loader-container\" role=\"alert\" aria-label=\"Loading\">\n    <div className=\"csv-generator-loader\" />\n  </div>\n)\n\nexport default Loader;\n","export const isIsoDate = (value: string) => {\n  if (!!Number(value)) {\n    return false;\n  }\n\n  return !!Date.parse(value);\n};\n","import * as React from 'react';\nimport * as fileSaver from 'file-saver';\nimport * as _dateFormat from 'dateformat';\nimport axios, { AxiosResponse } from 'axios';\nimport cn from 'classnames';\nimport Loader from './components/Loader/Loader';\nimport TCsvGenerator, { Any, IEndpointDataObject, IParams } from './interface';\nimport { flatten } from 'array-flatten';\nimport { isIsoDate } from './helpers';\nimport './styles.scss';\n\nconst dateFormat = (_dateFormat as Any).default || _dateFormat\n\nconst CsvGenerator: React.FunctionComponent<TCsvGenerator> = (props) => {\n  const errorMessage = props.errorMessage || 'Something went wrong, please try again.'\n  const noDataMessage = props.noDataMessage || 'No data to generate the file.';\n  const [isGenerating, setIsGenerating] = React.useState(false);\n  let csvFileContent = '';\n\n  const fetchAllData = () => {\n    let finalData: IEndpointDataObject[] = [];\n    setIsGenerating(true);\n\n    if (props.baseEndpoint) {\n      axios.get(`${props.baseEndpoint}`, { params: props.endpointDetails })\n        .then(res => {\n          const { total_pages } = res.data;\n          finalData = getDataObject(res);\n\n          if (!finalData.length) {\n            setIsGenerating(false);\n            return alert(noDataMessage);\n          }\n\n          if (total_pages > 1) {\n            const promises = [];\n\n            for (let page = 2; page <= total_pages; page++) {\n              const newParams = { ...props.endpointDetails, page };\n              promises.push(fetchData(newParams));\n            }\n\n            Promise.all(promises)\n              .then((res: IEndpointDataObject[][]) => {\n                finalData = [...finalData, ...flatten(res)];\n                generateCSV(finalData);\n              })\n              .catch(() => {\n                setIsGenerating(false);\n                alert(errorMessage);\n              });\n          } else {\n            generateCSV(finalData);\n          }\n        })\n        .catch(() => {\n          setIsGenerating(false);\n          alert(errorMessage);\n        })\n    } else if (props.items && props.items.length) {\n      generateCSV(props.items);\n    } else {\n      setIsGenerating(false);\n      alert(noDataMessage);\n    }\n  };\n\n  const fetchData = (params: IParams) => (\n    new Promise((resolve, reject) => {\n      axios.get(`${props.baseEndpoint}`, { params })\n      .then(res => {\n        const data = getDataObject(res);\n        resolve(data);\n      })\n      .catch(() => {\n        reject(errorMessage);\n      })\n    })\n  );\n\n  const generateCSV = (array: IEndpointDataObject[]) => {\n    array.forEach((obj, index) => {\n      if (index === 0) {\n        fillFileHeadlines(obj);\n      }\n\n      fillFileData(obj);\n    });\n\n    const blob = new Blob([addExcelUtf8Support(csvFileContent)], { type: 'text/csv;encoding:utf-8' });\n\n    fileSaver.saveAs(blob, `${props.fileName}.csv`);\n    setIsGenerating(false);\n  };\n\n  const fillFileHeadlines = (obj: IEndpointDataObject) => {\n    Object.keys(obj).forEach((key: string, i: number) => {\n      updateFileContentWithProperData(key, i);\n    });\n\n    csvFileContent += '\\n';\n  };\n\n  const fillFileData = (obj: IEndpointDataObject) => {\n    Object.keys(obj).forEach((key, i) => {\n      updateFileContentWithProperData(obj[key], i);\n    });\n\n    csvFileContent += '\\n';\n  };\n\n  const updateFileContentWithProperData = (value: IEndpointDataObject | string | number | null, i: number) => {\n    let result;\n    const stringValue = value === null ? '' : value.toString();\n\n    if (typeof value === 'object' && value !== null) {\n      result = getObjectValues(value);\n    } else if (isIsoDate(stringValue)) {\n      result = dateFormat(stringValue, 'dd/mm/yyyy');\n    } else {\n      const label = getLabel(stringValue);\n      result = label.replace(/\"/g, '\"\"');\n    }\n\n    result = escapeValue(result);\n\n    if (i > 0) {\n      csvFileContent += ',';\n    }\n\n    csvFileContent += result;\n  };\n\n  const getObjectValues = (obj: IEndpointDataObject) => {\n    let objectValues = '';\n    const setObjectValues = (val: IEndpointDataObject | string | number | null, name?: string) => {\n      if (val === null) return;\n\n      if (typeof val === 'object') {\n        Object.keys(val).forEach((key) => {\n          const isNestedObject = typeof val[key] === 'object' && val[key] !== null;\n\n          if (isNestedObject) {\n            const label = getLabel(key);\n            objectValues += `${label}: \\u2028`;\n          }\n\n          setObjectValues(val[key], key);\n\n          if (isNestedObject) {\n            objectValues += `\\u2028`;\n          }\n        });\n      } else {\n        let result = val.toString().replace(/\"/g, '\"\"');\n        const labelName = name ? getLabel(name) : '';\n        const labelResult = getLabel(result);\n\n        result = `  ${labelName}: ${labelResult}`;\n        objectValues += result + `\\u2028`;\n      }\n\n      return;\n    };\n\n    setObjectValues(obj);\n    return objectValues;\n  };\n\n  const escapeValue = (value: string) => {\n    if (value.search(/(\"|,|\\n)/g) >= 0) {\n      return `\"${value}\"`;\n    }\n\n    return value;\n  };\n\n  const getLabel = (value: string): string => {\n    const label = props.labels && props.labels[value];\n\n    if (label) {\n      return label;\n    }\n\n    return value;\n  };\n\n  const addExcelUtf8Support = (data: string) => {\n    return '\\uFEFF' + data;\n  };\n\n  const getDataObject = (res: AxiosResponse) => (\n    props.objectNameInResponse ? res.data[props.objectNameInResponse] : res.data\n  );\n\n  return (\n    <div className={cn('csv-generator-holder', props.className)}>\n      <button\n        onClick={fetchAllData}\n        className={cn('csv-generator-btn', isGenerating && 'csv-generator-hide')}\n        data-cy=\"csv-generator-btn\"\n      >\n        {props.children}\n      </button>\n      {isGenerating && (props.loader || <Loader />)}\n    </div>\n  )\n};\n\nexport default CsvGenerator;\n"],"names":["React.createElement","_dateFormat.default","flatten","fileSaver.saveAs"],"mappings":"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"}